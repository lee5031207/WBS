# https://tech.kakaoent.com/front-end/2022/220106-github-actions/
# https://github.com/actions ğŸ‘ˆì—¬ê¸°ì„œ actions í™•ì¸ ê°€ëŠ¥

name: "deploy_wbs_back"

# main ë¸Œëœì¹˜ì— push ë  ë•Œë§ˆë‹¤ ì‹¤í–‰ë¨
on:
  push:
    branched: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: âœ” ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

	    - name: âœ” Java JDKì„¤ì¹˜
	  	  uses: actions/setup-java@v2 
		    with:
			    java-version: '17'
			    distribution: 'temurin'

      - name: ğŸ” JDK ë²„ì „ í™•ì¸
        run: java -version
      
      - name: ğŸ”‘ application-dev.properties ìƒì„±
        run: |
          echo "${{ secrets.WBS_DEV_PROPERTIES }}" > src/main/resources/application-dev.properties

      - name: ğŸ§± Gradle build (bootJar ìƒì„±)
        run: ./gradlew bootJar

      - name: ğŸ“¦ jar ë¹Œë“œ íŒŒì¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: wbs-backend-build
          path: build/libs/*.jar

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ ë¹Œë“œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: wbs-backend-build
          path: ./deploy
      
      - name: ğŸ”’ SSH key íŒŒì¼ ìƒì„±
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: ğŸ”’ Copy files to EC2
        run: |
          scp -i ec2_key.pem -o StrictHostKeyChecking=no -r ./deploy/*.jar ubuntu@${{ secrets.EC2_HOST }}:/app/backend/deploy/

      - name: ğŸ” EC2 Spring Boot ì¬ê¸°ë™
        run: |
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            sudo pkill -f 'java -jar' || true
            sudo nohup java -jar /app/backend/deploy/*.jar --spring.profiles.active=dev > wbs.log 2>&1 &
          EOF
